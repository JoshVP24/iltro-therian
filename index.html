<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Filtro Therian</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        /* ESTILOS TIPO INSTAGRAM */
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; background-color: #000; color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        .top-bar {
            width: 100%; padding: 15px; text-align: center; font-weight: 600; font-size: 18px; letter-spacing: 1px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); position: absolute; top: 0; z-index: 300;
        }
        #camera-container { 
            flex-grow: 1; position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #111; overflow: hidden;
        }
        
        /* LA MAGIA DEL CLON CSS */
        video, canvas { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); 
        }
        video { z-index: 1; }
        canvas { z-index: 100; pointer-events: none; }
        
        #ruleta { 
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); padding: 15px; border-radius: 20px; 
            font-size: 22px; font-weight: bold; text-align: center; z-index: 200; display: none; border: 1px solid rgba(255,255,255,0.1);
        }
        .bottom-bar {
            width: 100%; padding: 30px 20px; background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
            display: flex; justify-content: center; align-items: center; position: absolute; bottom: 0; z-index: 300;
        }
        #btn-descubrir {
            width: 80px; height: 80px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.9); border: 5px solid rgba(255, 255, 255, 0.3);
            cursor: pointer; outline: none; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; font-size: 0;
        }
        #btn-descubrir:active { transform: scale(0.95); }
        #btn-descubrir:disabled { background-color: rgba(255, 255, 255, 0.2); border-color: transparent; animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0% { opacity: 0.6; scale: 0.95; } 50% { opacity: 1; scale: 1; } 100% { opacity: 0.6; scale: 0.95; } }
    </style>
</head>
<body>
    <div class="top-bar">DESCUBRE TU THERIAN</div>
    <div id="camera-container">
        <div id="ruleta">‚ùì</div>
        <video id="webcam" autoplay playsinline webkit-playsinline muted></video>
        <canvas id="output_canvas"></canvas>
    </div>
    <div class="bottom-bar">
        <button id="btn-descubrir" disabled>Girar</button>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output_canvas');
        const ctx = canvas.getContext('2d');
        const boton = document.getElementById('btn-descubrir');
        const ruleta = document.getElementById('ruleta');

        const therians = [
            { emoji: "üê∫ Lobo", archivoOrejas: "orejas-lobo.png", archivoCentro: "hocico-lobo.png" },
            { emoji: "üê± Gato", archivoOrejas: "orejas-gato.png", archivoCentro: "nariz-gato.png" },
            { emoji: "ü¶ä Zorro", archivoOrejas: "orejas-zorro.png", archivoCentro: "hocico-zorro.png" },
            { emoji: "üê∂ Perro", archivoOrejas: "orejas-perro.png", archivoCentro: "hocico-perro.png" },
            { emoji: "ü¶Ö √Åguila", archivoOrejas: null, archivoCentro: "pico-aguila.png" },
            { emoji: "üêª Oso", archivoOrejas: "orejas-oso.png", archivoCentro: "hocico-oso.png" },
            { emoji: "ü¶å Ciervo", archivoOrejas: "cuernos-ciervo.png", archivoCentro: "nariz-ciervo.png" },
            { emoji: "üêæ Lince", archivoOrejas: "orejas-lince.png", archivoCentro: "hocico-lince.png" }
        ];

        let animalActual = null; 
        let assets = {}; 
        let iaLista = false;

        // Cargando im√°genes
        therians.forEach(animal => {
            assets[animal.emoji] = { orejas: new Image(), centro: new Image() };
            if(animal.archivoOrejas) assets[animal.emoji].orejas.src = animal.archivoOrejas;
            if(animal.archivoCentro) assets[animal.emoji].centro.src = animal.archivoCentro; 
        });

        // Configuraci√≥n de la IA
        const faceMesh = new FaceMesh({locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/${file}`;
        }});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: false, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        // Lo que hace cuando te detecta
        faceMesh.onResults((results) => {
            if (!iaLista) { iaLista = true; boton.disabled = false; }

            if (video.videoWidth === 0) return;
            
            // Iguala la resoluci√≥n interna del canvas a la de la c√°mara
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && animalActual) {
                const rostro = results.multiFaceLandmarks[0];
                const frente = rostro[10];   
                const nariz = rostro[1];     
                const mejillaIzq = rostro[234];
                const mejillaDer = rostro[454];

                const anchoCara = Math.abs(mejillaDer.x - mejillaIzq.x) * canvas.width;
                const orejasImg = assets[animalActual].orejas;
                const centroImg = assets[animalActual].centro;

                // --- CALIBRACI√ìN ---
                const escalaOrejas = 2.0;  
                const alturaOrejas = 0.5;  
                const escalaHocico = 1.0;  // Hocico grande
                const alturaHocico = 0.18; // Hocico hacia abajo
                // -------------------

                if (orejasImg.src && orejasImg.complete && orejasImg.naturalWidth > 0) {
                    const anchoOrejas = anchoCara * escalaOrejas; 
                    const altoOrejas = (orejasImg.height / orejasImg.width) * anchoOrejas;
                    const xOrejas = (frente.x * canvas.width) - (anchoOrejas / 2);
                    const yOrejas = (frente.y * canvas.height) - altoOrejas + (anchoCara * alturaOrejas); 
                    ctx.drawImage(orejasImg, xOrejas, yOrejas, anchoOrejas, altoOrejas);
                }

                if (centroImg.src && centroImg.complete && centroImg.naturalWidth > 0) {
                    const anchoCentro = anchoCara * escalaHocico; 
                    const altoCentro = (centroImg.height / centroImg.width) * anchoCentro;
                    const xCentro = (nariz.x * canvas.width) - (anchoCentro / 2);
                    const yCentro = (nariz.y * canvas.height) - (altoCentro / 2) + (anchoCara * alturaHocico);
                    ctx.drawImage(centroImg, xCentro, yCentro, anchoCentro, altoCentro);
                }
            }
        });

        // EL MOTOR OFICIAL DE GOOGLE (A prueba de celulares)
        const camera = new Camera(video, {
            onFrame: async () => {
                await faceMesh.send({image: video});
            },
            width: 720,
            height: 1280
        });
        camera.start();

        // Acci√≥n del bot√≥n
        boton.addEventListener('click', () => {
            if (!iaLista) return;
            boton.style.transform = "scale(0.9)";
            setTimeout(() => boton.style.transform = "scale(1)", 200);

            boton.disabled = true;
            ruleta.style.display = "block";
            animalActual = null; 
            
            let tiempoGiro = 0;
            const intervalo = setInterval(() => {
                const indexAleatorio = Math.floor(Math.random() * therians.length);
                ruleta.innerText = therians[indexAleatorio].emoji;
                tiempoGiro += 100;

                if (tiempoGiro >= 3000) {
                    clearInterval(intervalo);
                    const ganador = therians[Math.floor(Math.random() * therians.length)];
                    ruleta.innerHTML = `Tu Therian es:<br><span style="color:#bd6aff; font-size:32px;">${ganador.emoji}</span>`;
                    animalActual = ganador.emoji; 
                    boton.disabled = false;
                }
            }, 100); 
        });
    </script>
</body>
</html>
