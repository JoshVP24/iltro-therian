<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therian App - Radar</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; display: flex; flex-direction: column; align-items: center; background-color: #121212; color: white; font-family: sans-serif; overflow-x: hidden; }
        #contenedor-app { position: relative; width: 100%; max-width: 400px; margin-top: 20px; }
        
        /* AQU√ç EST√Å LA CORRECCI√ìN DE CAPAS */
        video { width: 100%; border-radius: 15px; transform: scaleX(-1); background: #000; display: block; position: relative; z-index: 1; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); border-radius: 15px; pointer-events: none; z-index: 100; }
        
        #ruleta { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); padding: 10px 20px; border-radius: 15px; font-size: 24px; font-weight: bold; z-index: 200; display: none; text-align: center; border: 2px solid #8a2be2; }
        button { margin-top: 20px; padding: 15px 30px; font-size: 20px; border-radius: 30px; border: none; background-color: #8a2be2; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4); z-index: 10; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        #consola { margin-top: 20px; width: 90%; max-width: 400px; background: #000; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; border-radius: 10px; border: 1px solid #333; text-align: left; height: 150px; overflow-y: auto; }
    </style>
</head>
<body>
    <h2>¬øCu√°l es tu Therian?</h2>
    
    <div id="contenedor-app">
        <div id="ruleta">‚ùì</div>
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <button id="btn-descubrir">¬°Girar la Ruleta!</button>

    <div id="consola">> Sistema Frontal iniciado...<br></div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output_canvas');
        const ctx = canvas.getContext('2d');
        const boton = document.getElementById('btn-descubrir');
        const ruleta = document.getElementById('ruleta');
        const consola = document.getElementById('consola');

        function log(mensaje) {
            consola.innerHTML += "> " + mensaje + "<br>";
            consola.scrollTop = consola.scrollHeight;
        }

        const therians = [
            { emoji: "üê∫ Lobo", archivoOrejas: "orejas-lobo.png", archivoCentro: "hocico-lobo.png" },
            { emoji: "üê± Gato", archivoOrejas: "orejas-gato.png", archivoCentro: "nariz-gato.png" },
            { emoji: "ü¶ä Zorro", archivoOrejas: "orejas-zorro.png", archivoCentro: "hocico-zorro.png" },
            { emoji: "üê∂ Perro", archivoOrejas: "orejas-perro.png", archivoCentro: "hocico-perro.png" },
            { emoji: "ü¶Ö √Åguila", archivoOrejas: null, archivoCentro: "pico-aguila.png" },
            { emoji: "üêª Oso", archivoOrejas: "orejas-oso.png", archivoCentro: "hocico-oso.png" },
            { emoji: "ü¶å Ciervo", archivoOrejas: "cuernos-ciervo.png", archivoCentro: "nariz-ciervo.png" },
            { emoji: "üêæ Lince", archivoOrejas: "orejas-lince.png", archivoCentro: "hocico-lince.png" }
        ];

        let animalActual = null; 
        let assets = {}; 
        let iaLista = false;

        log("Cargando im√°genes PNG...");
        therians.forEach(animal => {
            assets[animal.emoji] = { orejas: new Image(), centro: new Image() };
            if(animal.archivoOrejas) assets[animal.emoji].orejas.src = animal.archivoOrejas;
            if(animal.archivoCentro) assets[animal.emoji].centro.src = animal.archivoCentro; 
        });

        const faceMesh = new FaceMesh({locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/${file}`;
        }});

        faceMesh.setOptions({
          maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5, selfieMode: true
        });

        faceMesh.onResults((results) => {
            if (!iaLista) {
                iaLista = true;
                log("‚úÖ IA CARGADA Y LISTA.");
                boton.disabled = false;
                boton.innerText = "¬°Girar la Ruleta!";
            }

            // CORRECCI√ìN DE TAMA√ëO DE LIENZO PARA CELULARES
            if (video.videoWidth > 0) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            } else {
                canvas.width = 480;
                canvas.height = 640;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && animalActual) {
                const rostro = results.multiFaceLandmarks[0];
                const frente = rostro[10];   
                const nariz = rostro[1];     
                const mejillaIzq = rostro[234];
                const mejillaDer = rostro[454];

                // RADAR VISUAL DE PRUEBA: Dibuja un cuadrado azul brillante en la esquina y un c√≠rculo en tu nariz
                ctx.fillStyle = "blue";
                ctx.fillRect(20, 20, 80, 80); 
                
                ctx.fillStyle = "yellow";
                ctx.beginPath();
                ctx.arc(nariz.x * canvas.width, nariz.y * canvas.height, 15, 0, 2 * Math.PI);
                ctx.fill();

                const anchoCara = Math.abs(mejillaDer.x - mejillaIzq.x) * canvas.width;
                const orejasImg = assets[animalActual].orejas;
                const centroImg = assets[animalActual].centro;

                if (orejasImg.src && orejasImg.complete && orejasImg.naturalWidth > 0) {
                    const anchoOrejas = anchoCara * 1.5; 
                    const altoOrejas = (orejasImg.height / orejasImg.width) * anchoOrejas;
                    const xOrejas = (frente.x * canvas.width) - (anchoOrejas / 2);
                    const yOrejas = (frente.y * canvas.height) - altoOrejas + (anchoCara * 0.2); 
                    ctx.drawImage(orejasImg, xOrejas, yOrejas, anchoOrejas, altoOrejas);
                }

                if (centroImg.src && centroImg.complete && centroImg.naturalWidth > 0) {
                    const anchoCentro = anchoCara * 0.5; 
                    const altoCentro = (centroImg.height / centroImg.width) * anchoCentro;
                    const xCentro = (nariz.x * canvas.width) - (anchoCentro / 2);
                    const yCentro = (nariz.y * canvas.height) - (altoCentro / 2);
                    ctx.drawImage(centroImg, xCentro, yCentro, anchoCentro, altoCentro);
                }
            }
        });

        async function iniciarCamara() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: { ideal: 480 }, height: { ideal: 640 } } });
                video.srcObject = stream;
                await new Promise((resolve) => { video.onloadedmetadata = resolve; });
                boton.disabled = true;
                boton.innerText = "Cargando IA...";
                video.play();
                
                async function procesarFrame() {
                    await faceMesh.send({image: video});
                    video.requestVideoFrameCallback(procesarFrame);
                }
                video.requestVideoFrameCallback(procesarFrame);

            } catch (error) { log("‚ùå Error de c√°mara: " + error); }
        }
        iniciarCamara();

        boton.addEventListener('click', () => {
            if (!iaLista) return;
            boton.disabled = true;
            ruleta.style.display = "block";
            animalActual = null; 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            
            let tiempoGiro = 0;
            const intervalo = setInterval(() => {
                const indexAleatorio = Math.floor(Math.random() * therians.length);
                ruleta.innerText = therians[indexAleatorio].emoji;
                tiempoGiro += 100;

                if (tiempoGiro >= 3000) {
                    clearInterval(intervalo);
                    const ganador = therians[Math.floor(Math.random() * therians.length)];
                    ruleta.innerHTML = `¬°Eres un<br><span style="color:#8a2be2; font-size:30px;">${ganador.emoji}</span>!`;
                    animalActual = ganador.emoji; 
                    log("üéâ Resultado: " + ganador.emoji);
                    boton.disabled = false;
                    boton.innerText = "Girar de nuevo";
                }
            }, 100); 
        });
    </script>
</body>
</html>
