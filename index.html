<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Filtro Therian Definitivo</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 20px 0; background-color: #121212; color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        h2 { margin-top: 0; margin-bottom: 20px; font-size: 24px; text-align: center; }

        /* CONTENEDOR SIN ZOOM: Muestra el 100% de la c√°mara de tu celular */
        #camera-wrapper {
            position: relative;
            width: 95%; max-width: 480px;
            border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            background: #000;
            display: block;
        }

        /* Video y Canvas ahora se escalan de forma natural, sin recortar tu cara */
        video {
            width: 100%; height: auto; 
            display: block; transform: scaleX(-1);
        }
        canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
            transform: scaleX(-1);
        }
        
        #ruleta { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 80%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); padding: 15px; border-radius: 15px; 
            font-size: 22px; font-weight: bold; text-align: center; z-index: 200; display: none; 
            border: 2px solid #8a2be2;
        }

        .controles { margin-top: 20px; text-align: center; }

        #btn-descubrir {
            padding: 15px 40px; border-radius: 30px; background-color: #8a2be2; border: none;
            color: white; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.2s;
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
        }
        #btn-descubrir:disabled { background-color: #555; cursor: not-allowed; box-shadow: none; }
        #btn-descubrir:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <h2>¬øCu√°l es tu Therian?</h2>
    
    <div id="camera-wrapper">
        <div id="ruleta">‚ùì</div>
        <video id="webcam" autoplay playsinline webkit-playsinline muted></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div class="controles">
        <button id="btn-descubrir" disabled>Cargando IA...</button>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output_canvas');
        const ctx = canvas.getContext('2d');
        const boton = document.getElementById('btn-descubrir');
        const ruleta = document.getElementById('ruleta');

        const therians = [
            { emoji: "üê∫ Lobo", archivoOrejas: "orejas-lobo.png", archivoCentro: "hocico-lobo.png" },
            { emoji: "üê± Gato", archivoOrejas: "orejas-gato.png", archivoCentro: "nariz-gato.png" },
            { emoji: "ü¶ä Zorro", archivoOrejas: "orejas-zorro.png", archivoCentro: "hocico-zorro.png" },
            { emoji: "üê∂ Perro", archivoOrejas: "orejas-perro.png", archivoCentro: "hocico-perro.png" },
            { emoji: "ü¶Ö √Åguila", archivoOrejas: null, archivoCentro: "pico-aguila.png" },
            { emoji: "üêª Oso", archivoOrejas: "orejas-oso.png", archivoCentro: "hocico-oso.png" },
            { emoji: "ü¶å Ciervo", archivoOrejas: "cuernos-ciervo.png", archivoCentro: "nariz-ciervo.png" },
            { emoji: "üêæ Lince", archivoOrejas: "orejas-lince.png", archivoCentro: "hocico-lince.png" }
        ];

        let animalActual = null; 
        let assets = {}; 
        let iaLista = false;

        therians.forEach(animal => {
            assets[animal.emoji] = { orejas: new Image(), centro: new Image() };
            if(animal.archivoOrejas) assets[animal.emoji].orejas.src = animal.archivoOrejas;
            if(animal.archivoCentro) assets[animal.emoji].centro.src = animal.archivoCentro; 
        });

        const faceMesh = new FaceMesh({locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/${file}`;
        }});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: false, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        faceMesh.onResults((results) => {
            if (!iaLista) { 
                iaLista = true; 
                boton.disabled = false; 
                boton.innerText = "Girar Ruleta"; 
            }

            if (video.videoWidth === 0) return;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Si detecta el rostro (ahora s√≠ lo har√° en celular porque se ve completo)
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const rostro = results.multiFaceLandmarks[0];
                const frente = rostro[10];   
                const nariz = rostro[1];     
                const mejillaIzq = rostro[234];
                const mejillaDer = rostro[454];

                const anchoCara = Math.abs(mejillaDer.x - mejillaIzq.x) * canvas.width;

                if (animalActual) {
                    const orejasImg = assets[animalActual].orejas;
                    const centroImg = assets[animalActual].centro;

                    // ==========================================
                    // SOLUCI√ìN AL HOCICO BAJO
                    // ==========================================
                    const escalaOrejas = 1.8;  
                    const alturaOrejas = 0.5;  
                    
                    const escalaHocico = 1.0; 
                    // Regresamos este valor a 0.05 para que se siente justo en la punta de tu nariz y no en tu boca
                    const alturaHocico = 0.05; 
                    // ==========================================

                    if (orejasImg.src && orejasImg.complete && orejasImg.naturalWidth > 0) {
                        const anchoOrejas = anchoCara * escalaOrejas; 
                        const altoOrejas = (orejasImg.height / orejasImg.width) * anchoOrejas;
                        const xOrejas = (frente.x * canvas.width) - (anchoOrejas / 2);
                        const yOrejas = (frente.y * canvas.height) - altoOrejas + (anchoCara * alturaOrejas); 
                        ctx.drawImage(orejasImg, xOrejas, yOrejas, anchoOrejas, altoOrejas);
                    }

                    if (centroImg.src && centroImg.complete && centroImg.naturalWidth > 0) {
                        const anchoCentro = anchoCara * escalaHocico; 
                        const altoCentro = (centroImg.height / centroImg.width) * anchoCentro;
                        const xCentro = (nariz.x * canvas.width) - (anchoCentro / 2);
                        const yCentro = (nariz.y * canvas.height) - (altoCentro / 2) + (anchoCara * alturaHocico);
                        ctx.drawImage(centroImg, xCentro, yCentro, anchoCentro, altoCentro);
                    }
                }
            }
        });

        async function iniciarCamara() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    async function procesarFrame() {
                        if (video.readyState >= 2) { 
                            try { await faceMesh.send({image: video}); } catch(e) {} 
                        }
                        requestAnimationFrame(procesarFrame);
                    }
                    procesarFrame(); 
                };
            } catch (error) { alert("Aseg√∫rate de dar permisos de c√°mara."); }
        }
        iniciarCamara();

        boton.addEventListener('click', () => {
            if (!iaLista) return;
            boton.disabled = true;
            ruleta.style.display = "block";
            animalActual = null; 
            
            let tiempoGiro = 0;
            const intervalo = setInterval(() => {
                const indexAleatorio = Math.floor(Math.random() * therians.length);
                ruleta.innerText = therians[indexAleatorio].emoji;
                tiempoGiro += 100;

                if (tiempoGiro >= 3000) {
                    clearInterval(intervalo);
                    const ganador = therians[Math.floor(Math.random() * therians.length)];
                    ruleta.innerHTML = `¬°Eres un<br><span style="color:#bd6aff; font-size:32px;">${ganador.emoji}</span>!`;
                    animalActual = ganador.emoji; 
                    boton.disabled = false;
                    boton.innerText = "Girar de nuevo";
                }
            }, 100); 
        });
    </script>
</body>
</html>
